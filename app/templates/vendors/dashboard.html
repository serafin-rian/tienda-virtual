{% extends "base.html" %}

{% block title %}Panel de Vendedor - Tienda Virtual{% endblock %}

{% block head %}
<style>
    .dashboard-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        height: 100%;
    }
    .card-header {
        padding: 20px;
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        color: white;
    }
    .card-content {
        padding: 20px;
    }
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    .stat-trend {
        font-size: 0.9rem;
        padding: 3px 8px;
        border-radius: 12px;
        margin-left: 10px;
    }
    .trend-up {
        background: #d4edda;
        color: #155724;
    }
    .trend-down {
        background: #f8d7da;
        color: #721c24;
    }
    .trend-neutral {
        background: #e2e3e5;
        color: #383d41;
    }
    .quick-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
    }
    .quick-action-btn {
        flex: 1;
        min-width: 120px;
        text-align: center;
        padding: 15px 10px;
        border-radius: 8px;
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .quick-action-btn:hover {
        background: #e3f2fd;
        border-color: #2196f3;
        transform: translateY(-2px);
    }
    .product-table {
        width: 100%;
        border-collapse: collapse;
    }
    .product-table th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        border-bottom: 2px solid #e0e0e0;
    }
    .product-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    .product-table tr:hover {
        background: #f9f9f9;
    }
    .stock-indicator {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    .stock-high {
        background: #d4edda;
        color: #155724;
    }
    .stock-medium {
        background: #fff3cd;
        color: #856404;
    }
    .stock-low {
        background: #f8d7da;
        color: #721c24;
    }
    .status-badge {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    .status-confirmed {
        background: #cce5ff;
        color: #004085;
    }
    .status-shipped {
        background: #d1ecf1;
        color: #0c5460;
    }
    .status-delivered {
        background: #d4edda;
        color: #155724;
    }
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }
    .empty-state i {
        font-size: 4rem;
        color: #ddd;
        margin-bottom: 20px;
    }
    .chart-container {
        height: 300px;
        margin: 20px 0;
        position: relative;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .nav-tabs {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 20px;
    }
    .nav-tab {
        padding: 15px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }
    .nav-tab:hover {
        background: #f5f5f5;
    }
    .nav-tab.active {
        border-bottom-color: #2196f3;
        color: #2196f3;
        font-weight: bold;
    }
</style>
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h4 class="header blue-text">
            <i class="material-icons left">dashboard</i>
            Panel de Vendedor
        </h4>
        <p class="grey-text">Gestión y análisis de tu actividad comercial</p>
    </div>
</div>

<!-- Overlay de carga -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="preloader-wrapper big active">
        <div class="spinner-layer spinner-blue-only">
            <div class="circle-clipper left">
                <div class="circle"></div>
            </div>
            <div class="gap-patch">
                <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
                <div class="circle"></div>
            </div>
        </div>
    </div>
    <p id="loadingMessage">Cargando panel...</p>
</div>

<!-- Estado vacío (si no es vendedor) -->
<div class="row" id="notVendorState" style="display: none;">
    <div class="col s12 empty-state">
        <i class="material-icons">store</i>
        <h5>No eres un vendedor</h5>
        <p>Esta sección está disponible solo para usuarios con rol de vendedor.</p>
        <div class="row" style="margin-top: 20px;">
            <div class="col s12 m6">
                <a href="/crear-producto" class="btn waves-effect waves-light blue">
                    <i class="material-icons left">add_box</i>
                    Crear Producto
                </a>
            </div>
            <div class="col s12 m6">
                <a href="/catalogo" class="btn waves-effect waves-light green">
                    <i class="material-icons left">store</i>
                    Ver Catálogo
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Panel principal (visible solo para vendedores) -->
<div class="row" id="vendorPanel">
    <!-- Tabs de navegación -->
    <div class="col s12">
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('dashboard')">
                <i class="material-icons left">dashboard</i>Dashboard
            </div>
            <div class="nav-tab" onclick="switchTab('products')">
                <i class="material-icons left">inventory</i>Productos
            </div>
            <div class="nav-tab" onclick="switchTab('orders')">
                <i class="material-icons left">receipt</i>Pedidos
            </div>
            <div class="nav-tab" onclick="switchTab('customers')">
                <i class="material-icons left">people</i>Clientes
            </div>
            <div class="nav-tab" onclick="switchTab('analytics')">
                <i class="material-icons left">analytics</i>Análisis
            </div>
        </div>
    </div>

    <!-- Tab: Dashboard -->
    <div class="col s12 tab-content active" id="tabDashboard">
        <!-- Estadísticas rápidas -->
        <div class="row">
            <div class="col s12 m6 l3">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">trending_up</i>
                        <h6>Ventas Totales</h6>
                    </div>
                    <div class="card-content">
                        <div class="stat-number" id="totalRevenue">$0</div>
                        <p>Ingresos totales</p>
                        <span class="stat-trend trend-up" id="revenueTrend">+0%</span>
                    </div>
                </div>
            </div>
            
            <div class="col s12 m6 l3">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">shopping_cart</i>
                        <h6>Pedidos</h6>
                    </div>
                    <div class="card-content">
                        <div class="stat-number" id="totalOrders">0</div>
                        <p>Total pedidos</p>
                        <span class="stat-trend trend-up" id="ordersTrend">+0%</span>
                    </div>
                </div>
            </div>
            
            <div class="col s12 m6 l3">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">inventory</i>
                        <h6>Productos</h6>
                    </div>
                    <div class="card-content">
                        <div class="stat-number" id="totalProducts">0</div>
                        <p>En inventario</p>
                        <div>
                            <span class="stock-indicator stock-high" id="inStockCount">0 en stock</span>
                            <span class="stock-indicator stock-low" id="outOfStockCount">0 sin stock</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col s12 m6 l3">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">people</i>
                        <h6>Clientes</h6>
                    </div>
                    <div class="card-content">
                        <div class="stat-number" id="totalCustomers">0</div>
                        <p>Clientes únicos</p>
                        <span class="stat-trend trend-up" id="customersTrend">+0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gráfico de ventas -->
        <div class="row">
            <div class="col s12">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">bar_chart</i>
                        <h6>Ventas Recientes</h6>
                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Productos más vendidos -->
        <div class="row">
            <div class="col s12">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">star</i>
                        <h6>Productos Más Vendidos</h6>
                    </div>
                    <div class="card-content">
                        <table class="product-table" id="topProductsTable">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Ventas</th>
                                    <th>Ingresos</th>
                                    <th>Stock</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llena dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Acciones rápidas -->
        <div class="row">
            <div class="col s12">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">bolt</i>
                        <h6>Acciones Rápidas</h6>
                    </div>
                    <div class="card-content">
                        <div class="quick-actions">
                            <div class="quick-action-btn" onclick="window.location.href='/crear-producto'">
                                <i class="material-icons large blue-text">add_box</i>
                                <p>Crear Producto</p>
                            </div>
                            <div class="quick-action-btn" onclick="switchTab('products')">
                                <i class="material-icons large green-text">inventory</i>
                                <p>Gestionar Stock</p>
                            </div>
                            <div class="quick-action-btn" onclick="switchTab('orders')">
                                <i class="material-icons large orange-text">receipt</i>
                                <p>Ver Pedidos</p>
                            </div>
                            <div class="quick-action-btn" onclick="loadVendorStats()">
                                <i class="material-icons large purple-text">refresh</i>
                                <p>Actualizar Datos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Productos -->
    <div class="col s12 tab-content" id="tabProducts">
        <div class="row">
            <div class="col s12">
                <div class="dashboard-card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <i class="material-icons left">inventory</i>
                            <h6>Gestión de Inventario</h6>
                        </div>
                        <div>
                            <button class="btn waves-effect waves-light blue" onclick="window.location.href='/crear-producto'">
                                <i class="material-icons left">add</i>
                                Nuevo Producto
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <!-- Filtros -->
                        <div class="row" style="margin-bottom: 20px;">
                            <div class="col s12 m4">
                                <select id="stockFilter" onchange="filterProducts()">
                                    <option value="">Todo el stock</option>
                                    <option value="in_stock">En stock</option>
                                    <option value="out_of_stock">Sin stock</option>
                                    <option value="low_stock">Stock bajo</option>
                                </select>
                            </div>
                            <div class="col s12 m4">
                                <input type="text" id="productSearch" placeholder="Buscar producto..." onkeyup="filterProducts()">
                            </div>
                            <div class="col s12 m4">
                                <button class="btn waves-effect waves-light green" onclick="loadVendorInventory()">
                                    <i class="material-icons left">refresh</i>
                                    Actualizar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tabla de productos -->
                        <table class="product-table" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Precio</th>
                                    <th>Stock</th>
                                    <th>Estado</th>
                                    <th>Ventas</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llena dinámicamente -->
                            </tbody>
                        </table>
                        
                        <!-- Estadísticas del inventario -->
                        <div class="row" style="margin-top: 30px;">
                            <div class="col s12">
                                <div class="card-panel blue lighten-5">
                                    <div class="row" style="margin-bottom: 0;">
                                        <div class="col s6 m3">
                                            <h6 id="totalInventoryValue">$0</h6>
                                            <p>Valor total</p>
                                        </div>
                                        <div class="col s6 m3">
                                            <h6 id="productsNeedingRestock">0</h6>
                                            <p>Necesitan reposición</p>
                                        </div>
                                        <div class="col s6 m3">
                                            <h6 id="averageStockValue">$0</h6>
                                            <p>Valor promedio</p>
                                        </div>
                                        <div class="col s6 m3">
                                            <h6 id="sellThroughRate">0%</h6>
                                            <p>Tasa de venta</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Pedidos -->
    <div class="col s12 tab-content" id="tabOrders">
        <div class="row">
            <div class="col s12">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">receipt</i>
                        <h6>Pedidos de Clientes</h6>
                    </div>
                    <div class="card-content">
                        <!-- Filtros de pedidos -->
                        <div class="row" style="margin-bottom: 20px;">
                            <div class="col s12 m4">
                                <select id="orderStatusFilter" onchange="filterOrders()">
                                    <option value="">Todos los estados</option>
                                    <option value="pending">Pendiente</option>
                                    <option value="confirmed">Confirmado</option>
                                    <option value="shipped">Enviado</option>
                                    <option value="delivered">Entregado</option>
                                    <option value="cancelled">Cancelado</option>
                                </select>
                            </div>
                            <div class="col s12 m4">
                                <input type="date" id="orderDateFilter" onchange="filterOrders()">
                            </div>
                            <div class="col s12 m4">
                                <button class="btn waves-effect waves-light green" onclick="loadVendorSales()">
                                    <i class="material-icons left">refresh</i>
                                    Actualizar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tabla de pedidos -->
                        <table class="product-table" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Pedido</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Productos</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llena dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Clientes -->
    <div class="col s12 tab-content" id="tabCustomers">
        <div class="row">
            <div class="col s12">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">people</i>
                        <h6>Clientes</h6>
                    </div>
                    <div class="card-content">
                        <table class="product-table" id="customersTable">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Primera compra</th>
                                    <th>Última compra</th>
                                    <th>Pedidos</th>
                                    <th>Total gastado</th>
                                    <th>Valor promedio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llena dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Análisis -->
    <div class="col s12 tab-content" id="tabAnalytics">
        <div class="row">
            <div class="col s12 m6">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">analytics</i>
                        <h6>Rendimiento por Producto</h6>
                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="productPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col s12 m6">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">timeline</i>
                        <h6>Tendencias de Ventas</h6>
                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="salesTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col s12">
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="material-icons left">insights</i>
                        <h6>Métricas Clave</h6>
                    </div>
                    <div class="card-content">
                        <div class="row">
                            <div class="col s6 m3">
                                <div class="center-align">
                                    <h5 id="metricConversionRate">0%</h5>
                                    <p>Tasa de conversión</p>
                                </div>
                            </div>
                            <div class="col s6 m3">
                                <div class="center-align">
                                    <h5 id="metricAvgOrderValue">$0</h5>
                                    <p>Pedido promedio</p>
                                </div>
                            </div>
                            <div class="col s6 m3">
                                <div class="center-align">
                                    <h5 id="metricRepeatCustomers">0%</h5>
                                    <p>Clientes recurrentes</p>
                                </div>
                            </div>
                            <div class="col s6 m3">
                                <div class="center-align">
                                    <h5 id="metricInventoryTurnover">0.0</h5>
                                    <p>Rotación inventario</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar stock -->
<div id="editStockModal" class="modal">
    <div class="modal-content">
        <h4>Actualizar Stock</h4>
        <div id="editStockContent">
            <!-- Se llena dinámicamente -->
        </div>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close btn-flat">Cancelar</a>
        <button class="btn waves-effect waves-light blue" onclick="updateProductStock()">Actualizar</button>
    </div>
</div>

<!-- Modal para ver detalles de pedido -->
<div id="orderDetailsModal" class="modal">
    <div class="modal-content">
        <h4>Detalles del Pedido</h4>
        <div id="orderDetailsContent">
            <!-- Se llena dinámicamente -->
        </div>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close btn-flat">Cerrar</a>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Variables globales
let vendorData = null;
let currentUser = null;
let salesChart = null;
let productChart = null;
let trendChart = null;
let currentTab = 'dashboard';

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    initializeModals();
    loadCurrentUser();
});

// Inicializar modales
function initializeModals() {
    const modals = document.querySelectorAll('.modal');
    M.Modal.init(modals);
    
    const selects = document.querySelectorAll('select');
    M.FormSelect.init(selects);
}

// Cargar usuario actual
async function loadCurrentUser() {
    try {
        // En modo sin autenticación, usar usuario dummy
        currentUser = {
            id: 1,
            username: "anonymous",
            role: "customer" // Por defecto
        };
        
        // Verificar si hay usuarios vendedores
        const usersResponse = await fetch('/api/users');
        if (usersResponse.ok) {
            const users = await usersResponse.json();
            
            // Buscar si hay algún vendedor o admin
            const vendorUsers = users.filter(user => user.role === 'vendor' || user.role === 'admin');
            
            if (vendorUsers.length > 0) {
                // Usar el primer vendedor/admin encontrado
                currentUser = vendorUsers[0];
            }
        }
        
        // Verificar si es vendedor
        if (currentUser.role === 'vendor' || currentUser.role === 'admin') {
            document.getElementById('vendorPanel').style.display = 'block';
            document.getElementById('notVendorState').style.display = 'none';
            loadVendorDashboard();
        } else {
            document.getElementById('vendorPanel').style.display = 'none';
            document.getElementById('notVendorState').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error cargando usuario:', error);
    }
}

// Cambiar tab
function switchTab(tabName) {
    currentTab = tabName;
    
    // Actualizar tabs activos
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Activar tab seleccionado
    document.querySelector(`.nav-tab:nth-child(${getTabIndex(tabName)})`).classList.add('active');
    document.getElementById(`tab${capitalizeFirstLetter(tabName)}`).classList.add('active');
    
    // Cargar datos específicos del tab
    switch(tabName) {
        case 'dashboard':
            loadVendorDashboard();
            break;
        case 'products':
            loadVendorInventory();
            break;
        case 'orders':
            loadVendorSales();
            break;
        case 'customers':
            loadVendorCustomers();
            break;
        case 'analytics':
            loadVendorAnalytics();
            break;
    }
}

// Obtener índice del tab
function getTabIndex(tabName) {
    const tabs = ['dashboard', 'products', 'orders', 'customers', 'analytics'];
    return tabs.indexOf(tabName) + 1;
}

// Capitalizar primera letra
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

// Cargar dashboard del vendedor
async function loadVendorDashboard() {
    if (!currentUser || (currentUser.role !== 'vendor' && currentUser.role !== 'admin')) {
        return;
    }
    
    try {
        showLoading('Cargando dashboard...');
        
        const response = await fetch('/api/vendors/dashboard');
        if (response.ok) {
            vendorData = await response.json();
            renderDashboard(vendorData);
        } else {
            throw new Error('Error cargando dashboard');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: 'Error cargando dashboard: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Renderizar dashboard
function renderDashboard(data) {
    if (!data) return;
    
    // Actualizar estadísticas
    document.getElementById('totalRevenue').textContent = `$${data.sales_overview.total_revenue.toFixed(2)}`;
    document.getElementById('totalOrders').textContent = data.sales_overview.total_orders;
    document.getElementById('totalProducts').textContent = data.inventory_overview.total_products;
    document.getElementById('totalCustomers').textContent = data.total_customers || 0;
    
    // Actualizar indicadores de stock
    document.getElementById('inStockCount').textContent = `${data.inventory_overview.products_in_stock} en stock`;
    document.getElementById('outOfStockCount').textContent = `${data.inventory_overview.products_out_of_stock} sin stock`;
    
    // Actualizar tendencias
    updateTrendIndicators(data);
    
    // Renderizar productos más vendidos
    renderTopProducts(data.top_products);
    
    // Crear gráfico de ventas
    createSalesChart(data);
}

// Actualizar indicadores de tendencia
function updateTrendIndicators(data) {
    const recentOrders = data.sales_overview.recent_orders || 0;
    const totalOrders = data.sales_overview.total_orders || 1;
    const recentRevenue = data.sales_overview.recent_revenue || 0;
    const totalRevenue = data.sales_overview.total_revenue || 1;
    
    // Calcular porcentajes
    const orderPercentage = recentOrders > 0 ? Math.round((recentOrders / totalOrders) * 100) : 0;
    const revenuePercentage = recentRevenue > 0 ? Math.round((recentRevenue / totalRevenue) * 100) : 0;
    
    // Actualizar elementos
    document.getElementById('ordersTrend').textContent = `+${orderPercentage}%`;
    document.getElementById('revenueTrend').textContent = `+${revenuePercentage}%`;
}

// Renderizar productos más vendidos
function renderTopProducts(products) {
    const tbody = document.getElementById('topProductsTable').querySelector('tbody');
    tbody.innerHTML = '';
    
    if (!products || products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="center-align">No hay datos de productos vendidos</td></tr>';
        return;
    }
    
    products.forEach(product => {
        let stockClass = 'stock-high';
        if (product.current_stock === 0) {
            stockClass = 'stock-low';
        } else if (product.current_stock < 10) {
            stockClass = 'stock-medium';
        }
        
        tbody.innerHTML += `
            <tr>
                <td>
                    <strong>${product.product_name}</strong>
                    <p class="grey-text">ID: ${product.product_id}</p>
                </td>
                <td>${product.total_sold || 0} unidades</td>
                <td>$${product.total_revenue ? product.total_revenue.toFixed(2) : '0.00'}</td>
                <td>
                    <span class="stock-indicator ${stockClass}">
                        ${product.current_stock || 0} unidades
                    </span>
                </td>
                <td>
                    <button class="btn-small waves-effect waves-light blue" onclick="editProductStock(${product.product_id})">
                        <i class="material-icons">edit</i>
                    </button>
                    <button class="btn-small waves-effect waves-light green" onclick="viewProduct(${product.product_id})">
                        <i class="material-icons">visibility</i>
                    </button>
                </td>
            </tr>
        `;
    });
}

// Crear gráfico de ventas
function createSalesChart(data) {
    const ctx = document.getElementById('salesChart').getContext('2d');
    
    if (salesChart) {
        salesChart.destroy();
    }
    
    // Datos de ejemplo (en producción vendrían de la API)
    const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
    const salesData = [1200, 1900, 3000, 5000, 2000, 3000];
    const ordersData = [12, 19, 30, 50, 20, 30];
    
    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Ventas ($)',
                    data: salesData,
                    borderColor: '#2196f3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Pedidos',
                    data: ordersData,
                    borderColor: '#4caf50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Cargar inventario del vendedor
async function loadVendorInventory() {
    try {
        showLoading('Cargando inventario...');
        
        const response = await fetch('/api/vendors/inventory');
        if (response.ok) {
            const inventoryData = await response.json();
            renderInventory(inventoryData);
        } else {
            throw new Error('Error cargando inventario');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: 'Error cargando inventario: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Renderizar inventario
function renderInventory(data) {
    const tbody = document.getElementById('inventoryTable').querySelector('tbody');
    tbody.innerHTML = '';
    
    if (!data.products || data.products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="center-align">No tienes productos en inventario</td></tr>';
        return;
    }
    
    data.products.forEach(product => {
        let stockClass = 'stock-high';
        if (product.quantity === 0) {
            stockClass = 'stock-low';
        } else if (product.quantity < 10) {
            stockClass = 'stock-medium';
        }
        
        const stockText = product.quantity === 0 ? 'SIN STOCK' : 
                         product.quantity < 10 ? `BAJO (${product.quantity})` : 
                         `OK (${product.quantity})`;
        
        tbody.innerHTML += `
            <tr>
                <td>
                    <strong>${product.name}</strong>
                    <p class="grey-text">${product.description ? product.description.substring(0, 50) + '...' : 'Sin descripción'}</p>
                </td>
                <td>$${product.price.toFixed(2)}</td>
                <td>
                    <span class="stock-indicator ${stockClass}">
                        ${stockText}
                    </span>
                </td>
                <td>
                    ${product.requires_shipping ? '<i class="material-icons green-text" title="Requiere envío">local_shipping</i>' : 
                    '<i class="material-icons blue-text" title="Digital/No requiere envío">cloud</i>'}
                </td>
                <td>0 ventas</td>
                <td>
                    <button class="btn-small waves-effect waves-light blue" onclick="editProductStock(${product.id})">
                        <i class="material-icons">edit</i>
                    </button>
                    <button class="btn-small waves-effect waves-light green" onclick="viewProduct(${product.id})">
                        <i class="material-icons">visibility</i>
                    </button>
                    <button class="btn-small waves-effect waves-light red" onclick="deleteProduct(${product.id})">
                        <i class="material-icons">delete</i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    // Actualizar estadísticas
    if (data.stats) {
        document.getElementById('totalInventoryValue').textContent = `$${data.stats.total_value.toFixed(2)}`;
        document.getElementById('productsNeedingRestock').textContent = data.stats.needs_restock.length;
        document.getElementById('averageStockValue').textContent = `$${(data.stats.total_value / data.stats.total_products).toFixed(2)}`;
        document.getElementById('sellThroughRate').textContent = '0%'; // Por implementar
    }
}

// Filtrar productos
function filterProducts() {
    // Implementación básica - en producción sería más compleja
    const searchTerm = document.getElementById('productSearch').value.toLowerCase();
    const stockFilter = document.getElementById('stockFilter').value;
    
    const rows = document.querySelectorAll('#inventoryTable tbody tr');
    rows.forEach(row => {
        const productName = row.querySelector('td:nth-child(1) strong').textContent.toLowerCase();
        const stockText = row.querySelector('.stock-indicator').textContent.toLowerCase();
        
        let show = true;
        
        if (searchTerm && !productName.includes(searchTerm)) {
            show = false;
        }
        
        if (stockFilter === 'in_stock' && stockText.includes('sin stock')) {
            show = false;
        } else if (stockFilter === 'out_of_stock' && !stockText.includes('sin stock')) {
            show = false;
        } else if (stockFilter === 'low_stock' && (!stockText.includes('bajo') || stockText.includes('sin stock'))) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// Cargar ventas del vendedor
async function loadVendorSales() {
    try {
        showLoading('Cargando pedidos...');
        
        const response = await fetch('/api/vendors/sales');
        if (response.ok) {
            const salesData = await response.json();
            renderSales(salesData);
        } else {
            throw new Error('Error cargando pedidos');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: 'Error cargando pedidos: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Renderizar ventas
function renderSales(data) {
    const tbody = document.getElementById('ordersTable').querySelector('tbody');
    tbody.innerHTML = '';
    
    if (!data.sales || data.sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="center-align">No hay pedidos registrados</td></tr>';
        return;
    }
    
    data.sales.forEach(order => {
        let statusClass = 'status-pending';
        let statusText = 'Pendiente';
        
        switch(order.status) {
            case 'confirmed':
                statusClass = 'status-confirmed';
                statusText = 'Confirmado';
                break;
            case 'shipped':
                statusClass = 'status-shipped';
                statusText = 'Enviado';
                break;
            case 'delivered':
                statusClass = 'status-delivered';
                statusText = 'Entregado';
                break;
            case 'cancelled':
                statusClass = 'status-cancelled';
                statusText = 'Cancelado';
                break;
        }
        
        const orderDate = new Date(order.order_date).toLocaleDateString('es-ES');
        const itemsCount = order.items_count || 0;
        const itemsText = order.items ? order.items.map(item => item.product_name).join(', ') : '';
        
        tbody.innerHTML += `
            <tr>
                <td>
                    <strong>${order.order_number}</strong>
                    <p class="grey-text">ID: ${order.order_id}</p>
                </td>
                <td>${order.customer_id || 'Cliente'}</td>
                <td>${orderDate}</td>
                <td>
                    ${itemsCount} producto${itemsCount !== 1 ? 's' : ''}
                    <p class="grey-text small-text">${itemsText.substring(0, 30)}${itemsText.length > 30 ? '...' : ''}</p>
                </td>
                <td>$${order.order_revenue.toFixed(2)}</td>
                <td>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </td>
                <td>
                    <button class="btn-small waves-effect waves-light blue" onclick="viewOrderDetails(${order.order_id})">
                        <i class="material-icons">visibility</i>
                    </button>
                    ${order.status === 'pending' || order.status === 'confirmed' ? `
                    <button class="btn-small waves-effect waves-light green" onclick="updateOrderStatus(${order.order_id}, 'shipped')">
                        <i class="material-icons">local_shipping</i>
                    </button>
                    ` : ''}
                </td>
            </tr>
        `;
    });
}

// Filtrar pedidos
function filterOrders() {
    // Implementación básica
    const statusFilter = document.getElementById('orderStatusFilter').value;
    const dateFilter = document.getElementById('orderDateFilter').value;
    
    const rows = document.querySelectorAll('#ordersTable tbody tr');
    rows.forEach(row => {
        const statusText = row.querySelector('.status-badge').textContent.toLowerCase();
        const orderDate = row.querySelector('td:nth-child(3)').textContent;
        
        let show = true;
        
        if (statusFilter && statusText !== statusFilter) {
            show = false;
        }
        
        if (dateFilter && orderDate !== new Date(dateFilter).toLocaleDateString('es-ES')) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// Cargar clientes del vendedor
async function loadVendorCustomers() {
    try {
        showLoading('Cargando clientes...');
        
        const response = await fetch('/api/vendors/customers');
        if (response.ok) {
            const customersData = await response.json();
            renderCustomers(customersData);
        } else {
            throw new Error('Error cargando clientes');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: 'Error cargando clientes: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Renderizar clientes
function renderCustomers(data) {
    const tbody = document.getElementById('customersTable').querySelector('tbody');
    tbody.innerHTML = '';
    
    if (!data.top_customers || data.top_customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="center-align">No hay clientes registrados</td></tr>';
        return;
    }
    
    data.top_customers.forEach(customer => {
        const firstPurchase = new Date(customer.first_purchase).toLocaleDateString('es-ES');
        const lastPurchase = new Date(customer.last_purchase).toLocaleDateString('es-ES');
        const avgOrderValue = customer.total_orders > 0 ? customer.total_spent / customer.total_orders : 0;
        
        tbody.innerHTML += `
            <tr>
                <td>
                    <strong>${customer.username}</strong>
                    <p class="grey-text">ID: ${customer.customer_id}</p>
                </td>
                <td>${firstPurchase}</td>
                <td>${lastPurchase}</td>
                <td>${customer.total_orders}</td>
                <td>$${customer.total_spent.toFixed(2)}</td>
                <td>$${avgOrderValue.toFixed(2)}</td>
            </tr>
        `;
    });
}

// Cargar análisis del vendedor
async function loadVendorAnalytics() {
    try {
        showLoading('Cargando análisis...');
        
        const response = await fetch('/api/vendors/products/sales-stats');
        if (response.ok) {
            const analyticsData = await response.json();
            renderAnalytics(analyticsData);
        } else {
            throw new Error('Error cargando análisis');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: 'Error cargando análisis: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Renderizar análisis
function renderAnalytics(data) {
    // Crear gráfico de rendimiento por producto
    createProductPerformanceChart(data);
    
    // Crear gráfico de tendencias
    createSalesTrendChart(data);
    
    // Actualizar métricas
    updateMetrics(data);
}

// Crear gráfico de rendimiento por producto
function createProductPerformanceChart(data) {
    const ctx = document.getElementById('productPerformanceChart').getContext('2d');
    
    if (productChart) {
        productChart.destroy();
    }
    
    if (!data.all_products_stats || data.all_products_stats.length === 0) {
        return;
    }
    
    // Tomar top 5 productos
    const topProducts = data.all_products_stats.slice(0, 5);
    const labels = topProducts.map(p => p.product_name.substring(0, 15) + (p.product_name.length > 15 ? '...' : ''));
    const salesData = topProducts.map(p => p.recent_revenue);
    const stockData = topProducts.map(p => p.current_stock);
    
    productChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Ventas ($)',
                    data: salesData,
                    backgroundColor: '#2196f3',
                    borderColor: '#1976d2',
                    borderWidth: 1
                },
                {
                    label: 'Stock',
                    data: stockData,
                    backgroundColor: '#4caf50',
                    borderColor: '#388e3c',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Crear gráfico de tendencias de ventas
function createSalesTrendChart(data) {
    const ctx = document.getElementById('salesTrendChart').getContext('2d');
    
    if (trendChart) {
        trendChart.destroy();
    }
    
    // Datos de ejemplo (en producción vendrían de la API)
    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const revenueData = [1200, 1900, 3000, 5000, 2000, 3000, 4000, 3500, 4500, 5000, 6000, 7000];
    const ordersData = [12, 19, 30, 50, 20, 30, 40, 35, 45, 50, 60, 70];
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Ventas ($)',
                    data: revenueData,
                    borderColor: '#2196f3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Pedidos',
                    data: ordersData,
                    borderColor: '#4caf50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    hidden: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Actualizar métricas
function updateMetrics(data) {
    // Métricas de ejemplo
    document.getElementById('metricConversionRate').textContent = '2.5%';
    document.getElementById('metricAvgOrderValue').textContent = '$45.50';
    document.getElementById('metricRepeatCustomers').textContent = '35%';
    document.getElementById('metricInventoryTurnover').textContent = '4.2';
}

// Ver detalles de pedido
async function viewOrderDetails(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}`);
        if (response.ok) {
            const orderData = await response.json();
            
            let itemsHtml = '';
            if (orderData.items && orderData.items.length > 0) {
                orderData.items.forEach(item => {
                    itemsHtml += `
                        <tr>
                            <td>${item.product_name}</td>
                            <td>$${item.product_price.toFixed(2)}</td>
                            <td>${item.quantity}</td>
                            <td>$${item.subtotal.toFixed(2)}</td>
                        </tr>
                    `;
                });
            }
            
            document.getElementById('orderDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col s12">
                        <p><strong>Número de pedido:</strong> ${orderData.order.order_number}</p>
                        <p><strong>Fecha:</strong> ${new Date(orderData.order.created_at).toLocaleString('es-ES')}</p>
                        <p><strong>Estado:</strong> ${orderData.order.status}</p>
                        <p><strong>Total:</strong> $${orderData.order.total_amount.toFixed(2)}</p>
                        <p><strong>Método de pago:</strong> ${orderData.order.payment_method || 'No especificado'}</p>
                    </div>
                </div>
                
                <h5>Productos</h5>
                <table class="striped">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
            `;
            
            const modal = document.getElementById('orderDetailsModal');
            const modalInstance = M.Modal.getInstance(modal) || M.Modal.init(modal);
            modalInstance.open();
        }
    } catch (error) {
        console.error('Error cargando detalles del pedido:', error);
        M.toast({
            html: 'Error cargando detalles del pedido',
            classes: 'red'
        });
    }
}

// Editar stock de producto
function editProductStock(productId) {
    // Encontrar producto en los datos actuales
    const product = findProductById(productId);
    
    if (!product) {
        M.toast({
            html: 'Producto no encontrado',
            classes: 'orange'
        });
        return;
    }
    
    document.getElementById('editStockContent').innerHTML = `
        <div class="row">
            <div class="col s12">
                <h5>${product.name}</h5>
                <p>Precio: $${product.price ? product.price.toFixed(2) : '0.00'}</p>
                <p>Stock actual: <strong>${product.quantity || 0}</strong> unidades</p>
            </div>
            <div class="input-field col s12">
                <input type="number" id="newStockQuantity" value="${product.quantity || 0}" min="0">
                <label for="newStockQuantity">Nueva cantidad</label>
            </div>
            <div class="col s12">
                <input type="hidden" id="editingProductId" value="${productId}">
            </div>
        </div>
    `;
    
    const modal = document.getElementById('editStockModal');
    const modalInstance = M.Modal.getInstance(modal) || M.Modal.init(modal);
    modalInstance.open();
}

// Buscar producto por ID
function findProductById(productId) {
    // Buscar en diferentes fuentes de datos
    if (vendorData && vendorData.top_products) {
        const product = vendorData.top_products.find(p => p.product_id === productId);
        if (product) {
            return {
                id: product.product_id,
                name: product.product_name,
                quantity: product.current_stock,
                price: product.current_price
            };
        }
    }
    
    // Si no se encuentra, devolver datos básicos
    return {
        id: productId,
        name: `Producto ${productId}`,
        quantity: 0,
        price: 0
    };
}

// Actualizar stock de producto
async function updateProductStock() {
    const productId = document.getElementById('editingProductId').value;
    const newQuantity = parseInt(document.getElementById('newStockQuantity').value);
    
    if (isNaN(newQuantity) || newQuantity < 0) {
        M.toast({
            html: 'Cantidad inválida',
            classes: 'red'
        });
        return;
    }
    
    try {
        showLoading('Actualizando stock...');
        
        // En producción, esto llamaría a la API
        // const response = await fetch(`/api/products/${productId}`, {
        //     method: 'PUT',
        //     headers: {'Content-Type': 'application/json'},
        //     body: JSON.stringify({ quantity: newQuantity })
        // });
        
        // Por ahora simulamos la actualización
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        M.toast({
            html: '✅ Stock actualizado correctamente',
            classes: 'green'
        });
        
        // Recargar datos
        loadVendorDashboard();
        loadVendorInventory();
        
        // Cerrar modal
        const modal = document.getElementById('editStockModal');
        const modalInstance = M.Modal.getInstance(modal);
        if (modalInstance) modalInstance.close();
        
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: '❌ Error actualizando stock',
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Ver producto
function viewProduct(productId) {
    // Redirigir a la página del producto (por implementar)
    M.toast({
        html: `Viendo producto ${productId} (función en desarrollo)`,
        classes: 'blue'
    });
}

// Eliminar producto
async function deleteProduct(productId) {
    if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) {
        return;
    }
    
    try {
        showLoading('Eliminando producto...');
        
        const response = await fetch(`/api/products/${productId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            M.toast({
                html: '✅ Producto eliminado',
                classes: 'green'
            });
            
            // Recargar datos
            loadVendorDashboard();
            loadVendorInventory();
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Error eliminando producto');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: '❌ Error: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Actualizar estado del pedido
async function updateOrderStatus(orderId, newStatus) {
    try {
        const response = await fetch(`/api/orders/${orderId}/status?new_status=${newStatus}`, {
            method: 'PUT'
        });
        
        if (response.ok) {
            M.toast({
                html: '✅ Estado actualizado',
                classes: 'green'
            });
            
            // Recargar pedidos
            loadVendorSales();
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Error actualizando estado');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: '❌ Error: ' + error.message,
            classes: 'red'
        });
    }
}

// Mostrar loading
function showLoading(message = 'Cargando...') {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('loadingMessage').textContent = message;
}

// Ocultar loading
function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// Cargar estadísticas del vendedor (función genérica)
async function loadVendorStats() {
    switch(currentTab) {
        case 'dashboard':
            await loadVendorDashboard();
            break;
        case 'products':
            await loadVendorInventory();
            break;
        case 'orders':
            await loadVendorSales();
            break;
        case 'customers':
            await loadVendorCustomers();
            break;
        case 'analytics':
            await loadVendorAnalytics();
            break;
    }
}
</script>
{% endblock %}