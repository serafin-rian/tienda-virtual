{% extends "base.html" %}

{% block title %}Mi Carrito{% endblock %}

{% block head %}
<style>
    .cart-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .cart-item-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 5px;
    }
    .quantity-input {
        width: 60px;
        text-align: center;
        margin: 0 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
    }
    .quantity-btn {
        width: 30px;
        height: 30px;
        padding: 0;
        line-height: 30px;
        min-width: 30px;
    }
    .cart-summary {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        position: sticky;
        top: 20px;
    }
    .empty-cart {
        text-align: center;
        padding: 50px 20px;
    }
    .empty-cart i {
        font-size: 5rem;
        color: #ddd;
        margin-bottom: 20px;
    }
    .checkout-btn {
        width: 100%;
        margin-top: 20px;
        height: 50px;
        font-size: 1.1rem;
        font-weight: bold;
    }
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.9);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .stock-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        margin: 10px 0;
        border-radius: 0 5px 5px 0;
    }
    .address-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .address-card:hover {
        border-color: #2196f3;
        background: #f5f9ff;
    }
    .address-card.selected {
        border-color: #2196f3;
        background: #e3f2fd;
    }
    .checkout-section {
        display: none;
    }
    .payment-methods {
        display: flex;
        gap: 10px;
        margin: 15px 0;
    }
    .payment-method {
        flex: 1;
        text-align: center;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .payment-method.selected {
        border-color: #4caf50;
        background: #f1f8e9;
    }
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
    }
    .step-indicator::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 10%;
        right: 10%;
        height: 2px;
        background: #e0e0e0;
        z-index: 1;
    }
    .step {
        text-align: center;
        position: relative;
        z-index: 2;
        background: white;
        padding: 0 10px;
    }
    .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 5px;
        font-weight: bold;
    }
    .step.active .step-number {
        background: #2196f3;
        color: white;
    }
    .step.completed .step-number {
        background: #4caf50;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h4 class="header blue-text">
            <i class="material-icons left">shopping_cart</i>
            Mi Carrito de Compras
        </h4>
        <p class="grey-text">Revisa y gestiona los productos en tu carrito</p>
    </div>
</div>

<!-- Overlay de carga -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="preloader-wrapper big active">
        <div class="spinner-layer spinner-blue-only">
            <div class="circle-clipper left">
                <div class="circle"></div>
            </div>
            <div class="gap-patch">
                <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
                <div class="circle"></div>
            </div>
        </div>
    </div>
    <p id="loadingMessage">Procesando...</p>
</div>

<!-- Indicador de pasos (solo visible en checkout) -->
<div class="row" id="stepIndicator" style="display: none;">
    <div class="col s12">
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div>Carrito</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div>Envío</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div>Pago</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div>Confirmación</div>
            </div>
        </div>
    </div>
</div>

<!-- Estado de carrito vacío -->
<div class="row" id="emptyCart" style="display: none;">
    <div class="col s12 empty-cart">
        <i class="material-icons">remove_shopping_cart</i>
        <h5>Tu carrito está vacío</h5>
        <p>¡Añade algunos productos para comenzar a comprar!</p>
        <a href="/catalogo" class="btn waves-effect waves-light blue">
            <i class="material-icons left">store</i>
            Ir al catálogo
        </a>
    </div>
</div>

<!-- Contenido del carrito (se muestra cuando hay items) -->
<div class="row" id="cartContent">
    <!-- Paso 1: Carrito -->
    <div class="col s12 l8" id="stepCart">
        <div class="cart-table">
            <table class="highlight responsive-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="cartItems">
                    <!-- Los items se cargan dinámicamente -->
                </tbody>
            </table>
        </div>
        
        <!-- Advertencias de stock -->
        <div class="row" id="stockWarnings" style="display: none;">
            <div class="col s12">
                <div class="stock-warning">
                    <i class="material-icons left">warning</i>
                    <strong>Atención:</strong> Algunos productos tienen problemas de stock. 
                    Por favor revisa las cantidades antes de proceder al pago.
                </div>
            </div>
        </div>
        
        <!-- Botones de acción del carrito -->
        <div class="row" style="margin-top: 20px;">
            <div class="col s6">
                <a href="/catalogo" class="btn waves-effect waves-light grey">
                    <i class="material-icons left">arrow_back</i>
                    Seguir comprando
                </a>
            </div>
            <div class="col s6 right-align">
                <button class="btn waves-effect waves-light red" onclick="clearCart()" id="clearCartBtn">
                    <i class="material-icons left">delete</i>
                    Vaciar carrito
                </button>
                <button class="btn waves-effect waves-light blue" onclick="startCheckout()" id="checkoutBtn">
                    <i class="material-icons left">shopping_bag</i>
                    Proceder al pago
                </button>
            </div>
        </div>
    </div>
    
    <!-- Paso 2: Envío (oculto inicialmente) -->
    <div class="col s12 l8 checkout-section" id="stepShipping">
        <div class="card">
            <div class="card-content">
                <h5><i class="material-icons left">local_shipping</i>Dirección de envío</h5>
                
                <div id="addressList">
                    <p class="grey-text">Cargando direcciones...</p>
                </div>
                
                <div class="divider" style="margin: 20px 0;"></div>
                
                <h6>O crea una nueva dirección</h6>
                <div class="row">
                    <div class="input-field col s12">
                        <input type="text" id="newFullName" placeholder="Nombre completo">
                    </div>
                    <div class="input-field col s12">
                        <input type="text" id="newAddress" placeholder="Dirección (calle, número)">
                    </div>
                    <div class="input-field col s6">
                        <input type="text" id="newCity" placeholder="Ciudad">
                    </div>
                    <div class="input-field col s6">
                        <input type="text" id="newPostalCode" placeholder="Código postal">
                    </div>
                    <div class="input-field col s12">
                        <input type="text" id="newPhone" placeholder="Teléfono">
                    </div>
                    <div class="col s12">
                        <button class="btn waves-effect waves-light green" onclick="addNewAddress()">
                            <i class="material-icons left">add_location</i>
                            Agregar dirección
                        </button>
                    </div>
                </div>
                
                <div class="row" style="margin-top: 30px;">
                    <div class="col s6">
                        <button class="btn waves-effect waves-light grey" onclick="backToCart()">
                            <i class="material-icons left">arrow_back</i>
                            Volver
                        </button>
                    </div>
                    <div class="col s6 right-align">
                        <button class="btn waves-effect waves-light blue" onclick="goToPayment()" id="continueToPayment">
                            Continuar al pago
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Paso 3: Pago (oculto inicialmente) -->
    <div class="col s12 l8 checkout-section" id="stepPayment">
        <div class="card">
            <div class="card-content">
                <h5><i class="material-icons left">payment</i>Método de pago</h5>
                
                <div class="payment-methods">
                    <div class="payment-method selected" onclick="selectPaymentMethod('credit_card')" id="pmCreditCard">
                        <i class="material-icons medium">credit_card</i>
                        <p>Tarjeta de crédito</p>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('paypal')" id="pmPayPal">
                        <i class="material-icons medium">account_balance</i>
                        <p>PayPal</p>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('transfer')" id="pmTransfer">
                        <i class="material-icons medium">account_balance_wallet</i>
                        <p>Transferencia</p>
                    </div>
                </div>
                
                <div class="row" id="creditCardForm" style="margin-top: 20px;">
                    <div class="input-field col s12">
                        <input type="text" id="cardNumber" placeholder="Número de tarjeta">
                    </div>
                    <div class="input-field col s6">
                        <input type="text" id="cardExpiry" placeholder="MM/AA">
                    </div>
                    <div class="input-field col s6">
                        <input type="text" id="cardCVC" placeholder="CVC">
                    </div>
                    <div class="input-field col s12">
                        <input type="text" id="cardName" placeholder="Nombre en la tarjeta">
                    </div>
                </div>
                
                <div class="row" style="margin-top: 30px;">
                    <div class="col s6">
                        <button class="btn waves-effect waves-light grey" onclick="backToShipping()">
                            <i class="material-icons left">arrow_back</i>
                            Volver
                        </button>
                    </div>
                    <div class="col s6 right-align">
                        <button class="btn waves-effect waves-light green" onclick="placeOrder()" id="placeOrderBtn">
                            <i class="material-icons left">check</i>
                            Realizar pedido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resumen lateral (siempre visible) -->
    <div class="col s12 l4">
        <div class="cart-summary">
            <h5>Resumen de compra</h5>
            <div class="divider"></div>
            
            <div class="row" style="margin-top: 20px;">
                <div class="col s6">
                    <p><strong>Subtotal:</strong></p>
                    <p><strong>Envío:</strong></p>
                    <div class="divider" style="margin: 10px 0;"></div>
                    <h5><strong>Total:</strong></h5>
                </div>
                <div class="col s6 right-align">
                    <p id="summarySubtotal">$0.00</p>
                    <p id="summaryShipping">$0.00</p>
                    <div class="divider" style="margin: 10px 0;"></div>
                    <h5 id="summaryTotal">$0.00</h5>
                </div>
            </div>
            
            <!-- Información de envío gratis -->
            <div id="freeShippingInfo" style="display: none;">
                <div class="card-panel green lighten-5">
                    <p class="green-text">
                        <i class="material-icons left">local_shipping</i>
                        <strong>¡Envío gratis!</strong> Tu pedido califica para envío gratuito.
                    </p>
                </div>
            </div>
            
            <!-- Información de dirección seleccionada -->
            <div id="selectedAddressInfo" style="display: none; margin-top: 15px;">
                <h6><i class="material-icons left">location_on</i>Envío a:</h6>
                <p id="addressPreview" class="small-text"></p>
            </div>
            
            <!-- Información de pago seleccionado -->
            <div id="selectedPaymentInfo" style="display: none; margin-top: 15px;">
                <h6><i class="material-icons left">payment</i>Pago con:</h6>
                <p id="paymentPreview" class="small-text"></p>
            </div>
            
            <!-- Resumen de items -->
            <div id="itemsSummary" style="max-height: 200px; overflow-y: auto; margin-top: 15px;">
                <!-- Se llena dinámicamente -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación de pedido -->
<div id="orderConfirmationModal" class="modal">
    <div class="modal-content">
        <h4 class="green-text"><i class="material-icons left">check_circle</i>¡Pedido Confirmado!</h4>
        <div id="orderDetails">
            <!-- Se llena dinámicamente -->
        </div>
    </div>
    <div class="modal-footer">
        <a href="/mis-pedidos" class="btn waves-effect waves-light blue">
            <i class="material-icons left">receipt</i>
            Ver mis pedidos
        </a>
        <a href="/catalogo" class="btn waves-effect waves-light green">
            <i class="material-icons left">store</i>
            Seguir comprando
        </a>
        <a href="#!" class="modal-close btn-flat">Cerrar</a>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Variables globales
let cartData = null;
let selectedAddressId = null;
let selectedPaymentMethod = 'credit_card';
let checkoutStep = 1;

// Cargar carrito al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadCart();
    initializeModals();
});

// Inicializar modales de Materialize
function initializeModals() {
    const modals = document.querySelectorAll('.modal');
    M.Modal.init(modals);
}

// Mostrar loading
function showLoading(message = 'Procesando...') {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('loadingMessage').textContent = message;
}

// Ocultar loading
function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// Cargar carrito desde API
async function loadCart() {
    try {
        showLoading('Cargando tu carrito...');
        
        const response = await fetch('/api/cart/summary');
        
        if (response.status === 404) {
            showEmptyCart();
            return;
        }
        
        if (!response.ok) {
            throw new Error('Error cargando carrito');
        }
        
        cartData = await response.json();
        
        if (cartData.items && cartData.items.length > 0) {
            renderCartItems();
            updateCartSummary();
            checkStock();
            document.getElementById('cartContent').style.display = 'flex';
            document.getElementById('emptyCart').style.display = 'none';
            document.getElementById('stepIndicator').style.display = 'none';
            
            // Actualizar botones según el paso
            updateCheckoutButtons();
        } else {
            showEmptyCart();
        }
        
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: 'Error cargando carrito: ' + error.message,
            classes: 'red'
        });
        showEmptyCart();
    } finally {
        hideLoading();
    }
}

// Mostrar carrito vacío
function showEmptyCart() {
    document.getElementById('cartContent').style.display = 'none';
    document.getElementById('emptyCart').style.display = 'block';
    document.getElementById('stepIndicator').style.display = 'none';
}

// Renderizar items del carrito
function renderCartItems() {
    const tbody = document.getElementById('cartItems');
    tbody.innerHTML = '';
    
    cartData.items.forEach((item) => {
        const subtotal = (item.price * item.quantity).toFixed(2);
        const maxQuantity = Math.min(item.stock_available, 99);
        
        tbody.innerHTML += `
            <tr id="cart-item-${item.product_id}">
                <td>
                    <div style="display: flex; align-items: center;">
                        <img src="${item.image_url}" class="cart-item-image" alt="${item.product_name}" 
                             onerror="this.src='/static/no-image.png'">
                        <div style="margin-left: 15px;">
                            <h6 style="margin: 0 0 5px 0;">${item.product_name}</h6>
                            <small class="grey-text">${item.description || 'Sin descripción'}</small>
                        </div>
                    </div>
                </td>
                <td>$${item.price.toFixed(2)}</td>
                <td>
                    <div style="display: flex; align-items: center; justify-content: center;">
                        <button class="btn-floating btn-small waves-effect waves-light blue quantity-btn" 
                                onclick="updateQuantity(${item.product_id}, ${item.quantity - 1})"
                                ${item.quantity <= 1 ? 'disabled' : ''}>
                            <i class="material-icons">remove</i>
                        </button>
                        <input type="number" class="quantity-input" value="${item.quantity}" 
                               min="1" max="${maxQuantity}"
                               onchange="updateQuantity(${item.product_id}, this.value)" 
                               id="quantity-${item.product_id}">
                        <button class="btn-floating btn-small waves-effect waves-light blue quantity-btn" 
                                onclick="updateQuantity(${item.product_id}, ${item.quantity + 1})"
                                ${item.quantity >= maxQuantity ? 'disabled' : ''}>
                            <i class="material-icons">add</i>
                        </button>
                    </div>
                    <small class="grey-text">Disponible: ${item.stock_available}</small>
                </td>
                <td id="subtotal-${item.product_id}">$${subtotal}</td>
                <td>
                    <button class="btn-floating btn-small waves-effect waves-light red" 
                            onclick="removeFromCart(${item.product_id})">
                        <i class="material-icons">delete</i>
                    </button>
                </td>
            </tr>
        `;
    });
}

// Actualizar resumen del carrito
function updateCartSummary() {
    if (!cartData) return;
    
    document.getElementById('summarySubtotal').textContent = `$${cartData.subtotal.toFixed(2)}`;
    document.getElementById('summaryShipping').textContent = `$${cartData.shipping_cost.toFixed(2)}`;
    document.getElementById('summaryTotal').textContent = `$${cartData.grand_total.toFixed(2)}`;
    
    // Mostrar/ocultar envío gratis
    const freeShippingInfo = document.getElementById('freeShippingInfo');
    if (cartData.eligible_for_free_shipping) {
        freeShippingInfo.style.display = 'block';
    } else {
        freeShippingInfo.style.display = 'none';
    }
    
    // Actualizar resumen de items
    const itemsSummary = document.getElementById('itemsSummary');
    itemsSummary.innerHTML = '';
    
    cartData.items.slice(0, 3).forEach(item => {
        itemsSummary.innerHTML += `
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>${item.product_name} x${item.quantity}</span>
                <span>$${(item.price * item.quantity).toFixed(2)}</span>
            </div>
        `;
    });
    
    if (cartData.items.length > 3) {
        itemsSummary.innerHTML += `
            <div class="grey-text center-align">
                +${cartData.items.length - 3} más...
            </div>
        `;
    }
}

// Verificar stock
async function checkStock() {
    try {
        const response = await fetch('/api/cart/check-stock');
        if (response.ok) {
            const stockCheck = await response.json();
            
            const stockWarnings = document.getElementById('stockWarnings');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (!stockCheck.all_in_stock) {
                stockWarnings.style.display = 'block';
                checkoutBtn.disabled = true;
                checkoutBtn.innerHTML = '<i class="material-icons left">warning</i>Problemas de stock';
                
                // Mostrar detalles de problemas de stock
                let warningHtml = '<strong>Productos con stock insuficiente:</strong><ul>';
                stockCheck.details.forEach(item => {
                    warningHtml += `<li>${item.product_name}: Solicitaste ${item.requested}, disponible ${item.available}</li>`;
                });
                warningHtml += '</ul>';
                
                stockWarnings.innerHTML = `
                    <div class="stock-warning">
                        <i class="material-icons left">warning</i>
                        ${warningHtml}
                    </div>
                `;
            } else {
                stockWarnings.style.display = 'none';
                checkoutBtn.disabled = false;
                checkoutBtn.innerHTML = '<i class="material-icons left">shopping_bag</i>Proceder al pago';
            }
        }
    } catch (error) {
        console.error('Error verificando stock:', error);
    }
}

// Actualizar cantidad de un producto
async function updateQuantity(productId, newQuantity) {
    newQuantity = parseInt(newQuantity);
    
    if (newQuantity < 1) {
        newQuantity = 1;
    }
    
    try {
        showLoading('Actualizando cantidad...');
        
        const response = await fetch(`/api/cart/update/${productId}?quantity=${newQuantity}`, {
            method: 'PUT'
        });
        
        if (response.ok) {
            // Recargar carrito
            await loadCart();
            
            M.toast({
                html: '✅ Cantidad actualizada',
                classes: 'green',
                displayLength: 1500
            });
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Error actualizando cantidad');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: '❌ Error: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Eliminar producto del carrito
async function removeFromCart(productId) {
    if (!confirm('¿Estás seguro de que quieres eliminar este producto del carrito?')) {
        return;
    }
    
    try {
        showLoading('Eliminando producto...');
        
        const response = await fetch(`/api/cart/remove/${productId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Recargar carrito
            await loadCart();
            
            M.toast({
                html: '✅ Producto eliminado del carrito',
                classes: 'green',
                displayLength: 1500
            });
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Error eliminando producto');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: '❌ Error: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Vaciar carrito
async function clearCart() {
    if (!confirm('¿Estás seguro de que quieres vaciar todo el carrito?')) {
        return;
    }
    
    try {
        showLoading('Vaciando carrito...');
        
        const response = await fetch('/api/cart/clear', {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Mostrar carrito vacío
            showEmptyCart();
            
            M.toast({
                html: '✅ Carrito vaciado',
                classes: 'green',
                displayLength: 1500
            });
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Error vaciando carrito');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: '❌ Error: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Iniciar checkout
function startCheckout() {
    checkoutStep = 2;
    updateCheckoutStep();
    loadAddresses();
}

// Actualizar paso actual del checkout
function updateCheckoutStep() {
    // Mostrar/ocultar pasos
    document.getElementById('stepCart').style.display = checkoutStep === 1 ? 'block' : 'none';
    document.getElementById('stepShipping').style.display = checkoutStep === 2 ? 'block' : 'none';
    document.getElementById('stepPayment').style.display = checkoutStep === 3 ? 'block' : 'none';
    
    // Actualizar indicador
    document.getElementById('stepIndicator').style.display = 'flex';
    
    // Actualizar clases de pasos
    document.querySelectorAll('.step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNum < checkoutStep) {
            step.classList.add('completed');
        } else if (stepNum === checkoutStep) {
            step.classList.add('active');
        }
    });
    
    // Actualizar botones
    updateCheckoutButtons();
}

// Actualizar botones según el paso
function updateCheckoutButtons() {
    const checkoutBtn = document.getElementById('checkoutBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    
    if (checkoutStep === 1) {
        checkoutBtn.style.display = 'inline-block';
        clearCartBtn.style.display = 'inline-block';
    } else {
        checkoutBtn.style.display = 'none';
        clearCartBtn.style.display = 'none';
    }
}

// Volver al carrito
function backToCart() {
    checkoutStep = 1;
    updateCheckoutStep();
}

// Cargar direcciones
async function loadAddresses() {
    try {
        const response = await fetch('/api/addresses/me');
        if (response.ok) {
            const addresses = await response.json();
            renderAddresses(addresses);
        } else {
            document.getElementById('addressList').innerHTML = 
                '<p class="red-text">Error cargando direcciones</p>';
        }
    } catch (error) {
        console.error('Error cargando direcciones:', error);
        document.getElementById('addressList').innerHTML = 
            '<p class="red-text">Error cargando direcciones</p>';
    }
}

// Renderizar direcciones
function renderAddresses(addresses) {
    const container = document.getElementById('addressList');
    
    if (addresses.length === 0) {
        container.innerHTML = `
            <p class="grey-text">No tienes direcciones guardadas. Por favor crea una nueva.</p>
        `;
        return;
    }
    
    let html = '';
    addresses.forEach(addr => {
        const isSelected = selectedAddressId === addr.id;
        html += `
            <div class="address-card ${isSelected ? 'selected' : ''}" 
                 onclick="selectAddress(${addr.id})" 
                 id="address-${addr.id}">
                <h6>${addr.full_name}</h6>
                <p style="margin: 5px 0;">${addr.address_line1}</p>
                <p style="margin: 5px 0;">${addr.city}, ${addr.postal_code}</p>
                <p class="grey-text">${addr.phone_number}</p>
                ${addr.is_default ? '<span class="badge blue">Predeterminada</span>' : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Seleccionar la primera dirección por defecto si no hay seleccionada
    if (!selectedAddressId && addresses.length > 0) {
        const defaultAddr = addresses.find(a => a.is_default) || addresses[0];
        if (defaultAddr) {
            selectAddress(defaultAddr.id);
        }
    }
}

// Seleccionar dirección
function selectAddress(addressId) {
    selectedAddressId = addressId;
    
    // Actualizar UI
    document.querySelectorAll('.address-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.getElementById(`address-${addressId}`).classList.add('selected');
    
    // Actualizar resumen
    const address = document.getElementById(`address-${addressId}`);
    const addressPreview = document.getElementById('addressPreview');
    const selectedAddressInfo = document.getElementById('selectedAddressInfo');
    
    addressPreview.textContent = address.querySelector('h6').textContent + ', ' + 
                                address.querySelector('p').textContent;
    selectedAddressInfo.style.display = 'block';
    
    // Habilitar botón de continuar
    document.getElementById('continueToPayment').disabled = false;
}

// Agregar nueva dirección
async function addNewAddress() {
    const fullName = document.getElementById('newFullName').value.trim();
    const address = document.getElementById('newAddress').value.trim();
    const city = document.getElementById('newCity').value.trim();
    const postalCode = document.getElementById('newPostalCode').value.trim();
    const phone = document.getElementById('newPhone').value.trim();
    
    if (!fullName || !address || !city || !postalCode) {
        M.toast({
            html: 'Por favor completa todos los campos obligatorios',
            classes: 'orange'
        });
        return;
    }
    
    try {
        showLoading('Guardando dirección...');
        
        const formData = new FormData();
        formData.append('full_name', fullName);
        formData.append('address_line1', address);
        formData.append('city', city);
        formData.append('postal_code', postalCode);
        formData.append('phone_number', phone);
        formData.append('state_province', 'N/A');
        formData.append('country', 'ES');
        
        const response = await fetch('/api/addresses/', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const newAddress = await response.json();
            
            // Limpiar formulario
            document.getElementById('newFullName').value = '';
            document.getElementById('newAddress').value = '';
            document.getElementById('newCity').value = '';
            document.getElementById('newPostalCode').value = '';
            document.getElementById('newPhone').value = '';
            
            // Recargar direcciones
            await loadAddresses();
            
            // Seleccionar la nueva dirección
            selectAddress(newAddress.id);
            
            M.toast({
                html: '✅ Dirección guardada exitosamente',
                classes: 'green'
            });
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Error guardando dirección');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: '❌ Error: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Ir al paso de pago
function goToPayment() {
    if (!selectedAddressId) {
        M.toast({
            html: 'Por favor selecciona una dirección de envío',
            classes: 'orange'
        });
        return;
    }
    
    checkoutStep = 3;
    updateCheckoutStep();
    
    // Actualizar información de pago en el resumen
    updatePaymentPreview();
}

// Volver al paso de envío
function backToShipping() {
    checkoutStep = 2;
    updateCheckoutStep();
}

// Seleccionar método de pago
function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    
    // Actualizar UI
    document.querySelectorAll('.payment-method').forEach(pm => {
        pm.classList.remove('selected');
    });
    document.getElementById(`pm${method.charAt(0).toUpperCase() + method.slice(1).replace('_', '')}`).classList.add('selected');
    
    // Mostrar/ocultar formulario de tarjeta
    const creditCardForm = document.getElementById('creditCardForm');
    if (method === 'credit_card') {
        creditCardForm.style.display = 'block';
    } else {
        creditCardForm.style.display = 'none';
    }
    
    // Actualizar resumen
    updatePaymentPreview();
}

// Actualizar vista previa del pago
function updatePaymentPreview() {
    const paymentPreview = document.getElementById('paymentPreview');
    const selectedPaymentInfo = document.getElementById('selectedPaymentInfo');
    
    let methodText = '';
    switch (selectedPaymentMethod) {
        case 'credit_card':
            methodText = 'Tarjeta de crédito';
            break;
        case 'paypal':
            methodText = 'PayPal';
            break;
        case 'transfer':
            methodText = 'Transferencia bancaria';
            break;
        default:
            methodText = selectedPaymentMethod;
    }
    
    paymentPreview.textContent = methodText;
    selectedPaymentInfo.style.display = 'block';
}

// Realizar pedido
async function placeOrder() {
    if (!selectedAddressId) {
        M.toast({
            html: 'Por favor selecciona una dirección de envío',
            classes: 'orange'
        });
        return;
    }
    
    try {
        showLoading('Procesando tu pedido...');
        
        const response = await fetch('/api/cart/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                shipping_address_id: selectedAddressId,
                payment_method: selectedPaymentMethod,
                notes: ''
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Mostrar modal de confirmación
            showOrderConfirmation(result);
            
            // Resetear checkout
            checkoutStep = 1;
            selectedAddressId = null;
            selectedPaymentMethod = 'credit_card';
            
        } else {
            const error = await response.json();
            throw new Error(error.detail?.message || error.detail || 'Error procesando el pedido');
        }
    } catch (error) {
        console.error('Error:', error);
        M.toast({
            html: '❌ Error en checkout: ' + error.message,
            classes: 'red'
        });
    } finally {
        hideLoading();
    }
}

// Mostrar confirmación de pedido
function showOrderConfirmation(orderResult) {
    const modal = document.getElementById('orderConfirmationModal');
    const orderDetails = document.getElementById('orderDetails');
    
    let shipmentInfo = '';
    if (orderResult.shipment) {
        shipmentInfo = `
            <p><strong>Número de tracking:</strong> ${orderResult.shipment.tracking_number}</p>
            <p><strong>Entrega estimada:</strong> ${orderResult.shipment.estimated_delivery}</p>
        `;
    }
    
    orderDetails.innerHTML = `
        <div class="row">
            <div class="col s12">
                <p><strong>Número de pedido:</strong> ${orderResult.order.order_number}</p>
                <p><strong>Total:</strong> $${orderResult.order.total_amount.toFixed(2)}</p>
                <p><strong>Estado:</strong> ${orderResult.order.status}</p>
                <p><strong>Fecha:</strong> ${new Date(orderResult.order.created_at).toLocaleDateString('es-ES')}</p>
                ${shipmentInfo}
                <div class="divider" style="margin: 20px 0;"></div>
                <h6>Próximos pasos:</h6>
                <ul>
                    ${orderResult.next_steps.map(step => `<li>${step}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;
    
    const modalInstance = M.Modal.getInstance(modal) || M.Modal.init(modal);
    modalInstance.open();
    
    // Cerrar modal y redirigir después de 5 segundos
    setTimeout(() => {
        modalInstance.close();
        window.location.href = '/mis-pedidos';
    }, 10000);
}
</script>
{% endblock %}